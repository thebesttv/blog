#+title: Ch4 --- ç¬¬ä¸€æ¡æŒ‡ä»¤ ori çš„å®ç°

æµæ°´çº¿å°±çœŸ...æŒºç¥å¥‡çš„ ğŸ§

è¿™ä¸€ç« å®ç°äº†æœ€åˆç­‰çš„MIPSäº”çº§æµæ°´çº¿, åªèƒ½æ‰§è¡Œ =ori=.

#+caption: æœ€ç®€äº”çº§æµæ°´çº¿
{{{image(100)}}}
[[./pipeline.jpg]]

IDé˜¶æ®µç”Ÿæˆçš„ =wd= å’Œ =wreg=, è¿˜æœ‰EXé˜¶æ®µå¾—åˆ°çš„ =wdata= éƒ½è¢«ä¸€è·¯ä¼ é€’ä¸‹å»,ç›´
åˆ°æœ€åçš„WBé˜¶æ®µæ‰è¢«æ”¾åˆ°Regfileé‡Œé¢.  è¿˜æœ‰æ¯ä¸ªé˜¶æ®µä¹‹é—´çš„ buffer, è¿˜ä¸æ˜¯
å¾ˆéš¾ç†è§£çš„æ ·å­.

æ³¨æ„: PC çš„è¾“å‡º =pc= å’Œ =ce= éƒ½æ˜¯ä¼šç»™åˆ°å¤–éƒ¨çš„æŒ‡ä»¤å­˜å‚¨å™¨ =inst_rom= çš„,
åœ¨ =openmips= æ¨¡å—ä¸­ä¸¤ä¸ªä¿¡å·æ˜¯è¾“å‡º (=rom_addr_o=, =rom_ce_o=), è¿˜æœ‰ä¸€
ä¸ªæŒ‡ä»¤è¾“å…¥ =rom_data_i=.

#+caption: æ¨¡å—æ¥å£åŠå…³ç³»
{{{image(100)}}}
[[./modules.jpg]]

è¿™ä¸ªæœ€ç®€å®ç°å‡ ä¹ä¸è€ƒè™‘ä»»ä½•çš„ hazard.  è¿™æ„å‘³ç€ä¸èƒ½å†™è¿™æ ·çš„ä»£ç :
#+begin_src mips
  # ç›´æ¥ç›¸é‚»çš„ä¸è¡Œ
          ori         $1, $0, 0x1100
          ori         $2, $1, 0x0020
  # é—´éš”1ä¸ªçš„ä¹Ÿä¸è¡Œ
          ori         $1, $0, 0x1100
          ori         $3, $0, 0xffff
          ori         $2, $1, 0x0020
#+end_src
ç®€å•çš„ Read-After-Write hazard çš„å¤„ç†ä¼šåœ¨ç¬¬äº”ç« å®ç°.

ç”¨æ²¡æœ‰ hazard çš„æŒ‡ä»¤æµ‹è¯•:
#+include: "inst_rom.s" src mips

{{{image(100)}}}
[[./waveform.jpg]]

å¯ä»¥çœ‹åˆ°, ä» 210000ps å¼€å§‹å¾—åˆ°ç¬¬ä¸€æ¡æŒ‡ä»¤, ä¸€ç›´åˆ° 310000ps, è¿‡äº†äº”ä¸ªæ—¶
é’Ÿå‘¨æœŸå¯„å­˜å™¨è¢«å†™å…¥.

å…ˆæ˜¯å„ç§å®å®šä¹‰:
#+include: "defines.v" src verilog

ç„¶åæ˜¯ =pc_reg=, =if_id=, =regfile=, =id=, =id_ex=, =ex=, =ex_mem=,
=mem=, =mem_wb=:
#+include: "pc_reg.v" src verilog
#+include: "if_id.v" src verilog
#+include: "regfile.v" src verilog
#+include: "id.v" src verilog
#+include: "id_ex.v" src verilog
#+include: "ex.v" src verilog
#+include: "ex_mem.v" src verilog
#+include: "mem.v" src verilog
#+include: "mem_wb.v" src verilog

ç„¶åç”¨ =openmips= æŠŠå®ƒä»¬éƒ½è¿èµ·æ¥:
#+include: "openmips.v" src verilog

æœ‰äº† CPU æ ¸, è¿˜éœ€è¦å¤–å›´çš„æŒ‡ä»¤å­˜å‚¨å™¨ =inst_rom=:
#+include: "inst_rom.v" src verilog

é…±å°±å¯ä»¥æ­å»º SOPC å•¦:
#+include: "openmips_min_sopc.v" src verilog

æœ€åçš„ test bench:
#+include: "openmips_min_sopc_tb.v" src verilog
